name: Build Binary

on:
  push:
    tags:
      - 'v*'
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build helper binary for tests
      run: |
        echo "Building PACEMAKER helper binary for tests"
        cd helpers/pacemaker
        cargo build --release
        cd ../..
        
        # Copy the helper binary to embedded_binaries/
        mkdir -p embedded_binaries
        cp helpers/pacemaker/target/release/pacemaker_helper embedded_binaries/pacemaker_helper
        
        echo "Helper binary ready for tests"

    - name: Run tests
      run: cargo test --all-features

    - name: Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

  build-musl:
    needs: test
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            name: linux-musl-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            name: linux-musl-aarch64
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install cross
      run: cargo install cross --git https://github.com/cross-rs/cross

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

    - name: Clean build artifacts
      run: cargo clean

    - name: Build helper binary with MUSL
      run: |
        echo "Building PACEMAKER helper binary with static MUSL linking for ${{ matrix.target }}"
        cd helpers/pacemaker
        cross build --release --target ${{ matrix.target }}
        cd ../..
        
        # Copy the static helper binary to embedded_binaries/
        mkdir -p embedded_binaries
        cp helpers/pacemaker/target/${{ matrix.target }}/release/pacemaker_helper embedded_binaries/pacemaker_helper
        
        # Verify it's statically linked
        echo "Verifying helper binary is statically linked:"
        file embedded_binaries/pacemaker_helper
        ldd embedded_binaries/pacemaker_helper || echo "Static binary confirmed (ldd failed as expected)"

    - name: Install YARA for verification
      run: |
        sudo apt-get update
        sudo apt-get install -y yara

    - name: Verify YARA signatures in helper binary
      run: |
        echo "Verifying PACEMAKER helper binary contains required YARA signatures..."
        
        # Check for signature strings using strings command
        echo "Checking for /proc/%d/mem string:"
        strings embedded_binaries/pacemaker_helper | grep -F "/proc/%d/mem" || (echo "ERROR: /proc/%d/mem not found" && exit 1)
        
        echo "Checking for /proc/%s/maps string:"
        strings embedded_binaries/pacemaker_helper | grep -F "/proc/%s/maps" || (echo "ERROR: /proc/%s/maps not found" && exit 1)
        
        echo "Checking for /proc/%s/cmdline string:"
        strings embedded_binaries/pacemaker_helper | grep -F "/proc/%s/cmdline" || (echo "ERROR: /proc/%s/cmdline not found" && exit 1)
        
        echo "Checking for credential format string:"
        strings embedded_binaries/pacemaker_helper | grep -F "Name:%s || Pwd:%s || AuthNum:%s" || (echo "ERROR: Credential format string not found" && exit 1)
        
        # Run YARA scan
        echo "Running YARA scan against FE_APT_Trojan_Linux_PACEMAKER rule:"
        yara -s .github/yara/pacemaker.yar embedded_binaries/pacemaker_helper
        
        echo "YARA signature verification passed"

    - name: Build release binary
      run: cross build --release --target ${{ matrix.target }}

    - name: Get version info
      id: version
      run: |
        VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "signalbench") | .version')
        ARCH=$(echo ${{ matrix.target }} | cut -d'-' -f1)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "arch=$ARCH" >> $GITHUB_OUTPUT
        echo "target=${{ matrix.target }}" >> $GITHUB_OUTPUT
        echo "name=${{ matrix.name }}" >> $GITHUB_OUTPUT

    - name: Prepare binary for upload
      run: |
        mkdir -p release-artifacts
        cp target/${{ matrix.target }}/release/signalbench release-artifacts/signalbench-${{ steps.version.outputs.version }}-${{ steps.version.outputs.name }}
        chmod +x release-artifacts/signalbench-${{ steps.version.outputs.version }}-${{ steps.version.outputs.name }}

    - name: Upload binary
      uses: actions/upload-artifact@v4
      with:
        name: signalbench-${{ steps.version.outputs.version }}-${{ steps.version.outputs.name }}
        path: release-artifacts/signalbench-${{ steps.version.outputs.version }}-${{ steps.version.outputs.name }}
        retention-days: 30

  build-debian:
    needs: test
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: debian12-glibc2.36-x86_64
            container: debian:12
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            name: debian12-glibc2.36-aarch64
            container: debian:12
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Debian environment
      shell: bash
      run: |
        apt-get update
        apt-get install -y curl build-essential gcc pkg-config libssl-dev jq

    - name: Install Rust in Debian container
      shell: bash
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
        . ~/.cargo/env
        rustup target add ${{ matrix.target }}

    - name: Install cross-compilation tools
      if: matrix.target == 'aarch64-unknown-linux-gnu'
      shell: bash
      run: |
        apt-get install -y gcc-aarch64-linux-gnu

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

    - name: Configure cross-compilation
      if: matrix.target == 'aarch64-unknown-linux-gnu'
      shell: bash
      run: |
        mkdir -p ~/.cargo
        echo '[target.aarch64-unknown-linux-gnu]' >> ~/.cargo/config.toml
        echo 'linker = "aarch64-linux-gnu-gcc"' >> ~/.cargo/config.toml

    - name: Build helper binary
      shell: bash
      run: |
        . ~/.cargo/env
        echo "Building PACEMAKER helper binary for ${{ matrix.target }}"
        cd helpers/pacemaker
        cargo build --release --target ${{ matrix.target }}
        cd ../..
        
        # Copy the helper binary to embedded_binaries/
        mkdir -p embedded_binaries
        cp helpers/pacemaker/target/${{ matrix.target }}/release/pacemaker_helper embedded_binaries/pacemaker_helper
        
        echo "Helper binary ready for embedding"

    - name: Install YARA for verification
      shell: bash
      run: |
        apt-get update
        apt-get install -y yara

    - name: Verify YARA signatures in helper binary
      shell: bash
      run: |
        echo "Verifying PACEMAKER helper binary contains required YARA signatures..."
        
        # Check for signature strings using strings command
        echo "Checking for /proc/%d/mem string:"
        strings embedded_binaries/pacemaker_helper | grep -F "/proc/%d/mem" || (echo "ERROR: /proc/%d/mem not found" && exit 1)
        
        echo "Checking for /proc/%s/maps string:"
        strings embedded_binaries/pacemaker_helper | grep -F "/proc/%s/maps" || (echo "ERROR: /proc/%s/maps not found" && exit 1)
        
        echo "Checking for /proc/%s/cmdline string:"
        strings embedded_binaries/pacemaker_helper | grep -F "/proc/%s/cmdline" || (echo "ERROR: /proc/%s/cmdline not found" && exit 1)
        
        echo "Checking for credential format string:"
        strings embedded_binaries/pacemaker_helper | grep -F "Name:%s || Pwd:%s || AuthNum:%s" || (echo "ERROR: Credential format string not found" && exit 1)
        
        # Run YARA scan
        echo "Running YARA scan against FE_APT_Trojan_Linux_PACEMAKER rule:"
        yara -s .github/yara/pacemaker.yar embedded_binaries/pacemaker_helper
        
        echo "YARA signature verification passed"

    - name: Build release binary
      shell: bash
      run: |
        . ~/.cargo/env
        cargo build --release --target ${{ matrix.target }}

    - name: Validate GLIBC compatibility
      shell: bash
      run: |
        . ~/.cargo/env
        echo "GLIBC version in container: $(ldd --version | head -n1)"
        echo "Required GLIBC symbols in binary:"
        strings target/${{ matrix.target }}/release/signalbench | grep -E 'GLIBC_[0-9]' | sort -u | tail -5

    - name: Get version info
      id: version
      shell: bash
      run: |
        . ~/.cargo/env
        VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "signalbench") | .version')
        ARCH=$(echo ${{ matrix.target }} | cut -d'-' -f1)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "arch=$ARCH" >> $GITHUB_OUTPUT
        echo "target=${{ matrix.target }}" >> $GITHUB_OUTPUT
        echo "name=${{ matrix.name }}" >> $GITHUB_OUTPUT

    - name: Prepare binary for upload
      shell: bash
      run: |
        mkdir -p release-artifacts
        cp target/${{ matrix.target }}/release/signalbench release-artifacts/signalbench-${{ steps.version.outputs.version }}-${{ steps.version.outputs.name }}
        chmod +x release-artifacts/signalbench-${{ steps.version.outputs.version }}-${{ steps.version.outputs.name }}

    - name: Upload binary
      uses: actions/upload-artifact@v4
      with:
        name: signalbench-${{ steps.version.outputs.version }}-${{ steps.version.outputs.name }}
        path: release-artifacts/signalbench-${{ steps.version.outputs.version }}-${{ steps.version.outputs.name }}
        retention-days: 30

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-musl, build-debian]
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          signalbench-*/signalbench-*
        generate_release_notes: true
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          ## SignalBench ${{ github.ref_name }} - Endpoint Telemetry Generator
          
          This release includes binaries for multiple architectures and distributions:
          
          **Recommended (Static builds, no GLIBC dependency):**
          - `linux-musl-x86_64`: Universal Linux 64-bit (static, works on any Linux distribution)
          - `linux-musl-aarch64`: Universal Linux ARM64 (static, works on any Linux distribution)
          
          **GLIBC builds (for specific distributions):**
          - `debian12-glibc2.36-x86_64`: Debian 12/Ubuntu 22.04+ 64-bit (requires GLIBC 2.36+)
          - `debian12-glibc2.36-aarch64`: Debian 12/Ubuntu 22.04+ ARM64 (requires GLIBC 2.36+)
          
          ### Installation
          
          **For maximum compatibility (recommended):**
          ```bash
          # Download universal static binary (works on any Linux distribution)
          wget https://github.com/gocortex/signalbench/releases/download/${{ github.ref_name }}/signalbench-${{ github.ref_name }}-linux-musl-x86_64
          chmod +x signalbench-${{ github.ref_name }}-linux-musl-x86_64
          sudo mv signalbench-${{ github.ref_name }}-linux-musl-x86_64 /usr/local/bin/signalbench
          ```
          
          **For Debian 12/Ubuntu 22.04+ systems:**
          ```bash
          # Download GLIBC 2.36+ compatible binary
          wget https://github.com/gocortex/signalbench/releases/download/${{ github.ref_name }}/signalbench-${{ github.ref_name }}-debian12-glibc2.36-x86_64
          chmod +x signalbench-${{ github.ref_name }}-debian12-glibc2.36-x86_64
          sudo mv signalbench-${{ github.ref_name }}-debian12-glibc2.36-x86_64 /usr/local/bin/signalbench
          ```
          
          ### Usage
          ```bash
          # List available techniques
          ./signalbench list
          
          # Run a technique in dry-run mode
          ./signalbench run T1082 --dry-run
          
          # Get help
          ./signalbench --help
          ```
          
          ### Technical Details
          - **Built with Rust:** High performance and memory safety
          - **MITRE ATT&CK Integration:** Real technique implementations
          - **Cross-platform:** Multiple Linux distributions supported
          - **Safe Testing:** Built-in cleanup and safety mechanisms
